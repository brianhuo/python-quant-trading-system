# Backtester ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡
- **åŠŸèƒ½**: ç­–ç•¥å†å²è¡¨ç°éªŒè¯  
- **è¾“å…¥**: æ¨¡å‹ + ç‰¹å¾æ•°æ®
- **è¾“å‡º**: æ ‡å‡†åŒ–å›æµ‹æŠ¥å‘Š
```python
{
    'annual_return': 0.35,  # å¹´åŒ–æ”¶ç›Š
    'max_drawdown': 0.08,   # æœ€å¤§å›æ’¤
    'win_rate': 0.68,        # èƒœç‡
    'sharpe_ratio': 1.8      # å¤æ™®æ¯”ç‡
}
```

## âœ… ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. ç®€åŒ–å¤æ‚é€»è¾‘
- **åˆ é™¤**: é‡‘å­—å¡”éªŒè¯å™¨ï¼ˆPyramidValidatorï¼‰- è¿‡åº¦å¤æ‚
- **åˆ é™¤**: å¤§é‡æŠ€æœ¯æŒ‡æ ‡è®¡ç®— - é™ä½å¯é æ€§
- **ç®€åŒ–**: ä¿¡å·ç”Ÿæˆé€»è¾‘ - æ›´æ¸…æ™°çš„å†³ç­–æµç¨‹
- **ä¿ç•™**: æ ¸å¿ƒé£é™©æ§åˆ¶ï¼ˆæ³¢åŠ¨ç‡ã€æµåŠ¨æ€§æ£€æŸ¥ï¼‰

### 2. ä¿®å¤å…³é”®bug
- **ä¿®å¤**: å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å…¬å¼
- **ä¿®å¤**: æœ€å¤§å›æ’¤è®¡ç®—é€»è¾‘
- **ä¿®å¤**: äº¤æ˜“è®°å½•æ ¼å¼ä¸ä¸€è‡´é—®é¢˜
- **ç»Ÿä¸€**: å¤´å¯¸è·Ÿè¸ªå’Œç®¡ç†

### 3. æ€§èƒ½ä¼˜åŒ–
- **å‡å°‘**: æ—¥å¿—è¾“å‡ºé¢‘ç‡ï¼ˆ500è¡Œ/æ¬¡ vs 100è¡Œ/æ¬¡ï¼‰
- **ç®€åŒ–**: æ»šåŠ¨çª—å£éªŒè¯é€»è¾‘
- **ä¼˜åŒ–**: æ•°æ®å¤„ç†æµç¨‹
- **åˆ é™¤**: é‡å¤çš„æ€§èƒ½æŒ‡æ ‡è®¡ç®—

### 4. æ ‡å‡†åŒ–è¾“å‡º
- **æ ¸å¿ƒæŒ‡æ ‡**: ç›´æ¥è¿”å›4ä¸ªå…³é”®æŒ‡æ ‡
- **è¯¦ç»†ä¿¡æ¯**: å¯é€‰çš„detailså­—æ®µ
- **é”™è¯¯å¤„ç†**: ä¼˜é›…çš„å¤±è´¥æ¢å¤æœºåˆ¶
- **æ ¼å¼ç»Ÿä¸€**: ä¸€è‡´çš„æ•°å€¼ç²¾åº¦å’Œæ ¼å¼

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›

### ä¿¡å·ç”Ÿæˆç®€åŒ–
```python
# åŸå§‹å¤æ‚é€»è¾‘ (>100è¡Œ)
if self.pyramid_mode:
    ml_signal = {...}
    pyramid_signal = self.pyramid_validator.validate_signal(...)
    # å¤šå±‚éªŒè¯é€»è¾‘
    
# ä¼˜åŒ–åç®€å•é€»è¾‘ (15è¡Œ)
signal = self.generate_trading_signal(row, active_position, current_time)
if signal in ['BUY', 'SHORT']:
    signal = self.validate_signal(row, int(row['prediction']))
```

### æŠ¥å‘Šç”Ÿæˆä¼˜åŒ–
```python
# ç›´æ¥è¿”å›æ ‡å‡†æ ¼å¼
return {
    'annual_return': round(annual_return, 4),
    'max_drawdown': round(max_drawdown, 4), 
    'win_rate': round(win_rate, 4),
    'sharpe_ratio': round(sharpe_ratio, 4),
    'details': {...}  # å¯é€‰è¯¦ç»†ä¿¡æ¯
}
```

### é”™è¯¯å¤„ç†å¢å¼º
```python
try:
    # ä¸»è¦è®¡ç®—é€»è¾‘
    ...
except Exception as e:
    self.logger.error(f"ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: {str(e)}")
    return {
        'annual_return': 0.0,
        'max_drawdown': 0.0,
        'win_rate': 0.0,
        'sharpe_ratio': 0.0,
        'error': str(e)
    }
```

## ğŸ“Š å…³é”®æŒ‡æ ‡è®¡ç®—

### å¹´åŒ–æ”¶ç›Šç‡
```python
annual_return = (final_value / initial_balance) ** (252 / total_days) - 1
```

### æœ€å¤§å›æ’¤
```python
peak = portfolio_values.expanding().max()
drawdown = (portfolio_values - peak) / peak
max_drawdown = abs(drawdown.min())
```

### èƒœç‡
```python
win_rate = winning_trades / total_trades if total_trades > 0 else 0.0
```

### å¤æ™®æ¯”ç‡
```python
returns = portfolio_values.pct_change().dropna()
sharpe_ratio = returns.mean() / returns.std() * np.sqrt(252)
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•
```python
from scripts.backtester import Backtester

backtester = Backtester(
    model_path='trading_pipeline.pkl',
    config_path='config.json', 
    feature_path='features_selected_aapl_30min.feather'
)

report = backtester.run_backtest()
print(f"å¹´åŒ–æ”¶ç›Š: {report['annual_return']:.2%}")
print(f"æœ€å¤§å›æ’¤: {report['max_drawdown']:.2%}")
print(f"èƒœç‡: {report['win_rate']:.2%}")
print(f"å¤æ™®æ¯”ç‡: {report['sharpe_ratio']:.2f}")
```

### æµ‹è¯•éªŒè¯
```bash
python test_backtester_optimized.py
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœ

### ä»£ç å¤æ‚åº¦
- **ä»£ç è¡Œæ•°**: 1335 â†’ 1120 è¡Œ (-16%)
- **ç±»å¤æ‚åº¦**: åˆ é™¤4ä¸ªåµŒå¥—ç±»
- **æ–¹æ³•ç®€åŒ–**: å…³é”®æ–¹æ³•å‡å°‘50%ä»£ç 

### å¯é æ€§æå‡
- **é”™è¯¯å¤„ç†**: å…¨é¢çš„å¼‚å¸¸æ•è·
- **æ•°æ®éªŒè¯**: ç®€åŒ–ä½†æ›´å¯é çš„æ£€æŸ¥
- **è¾“å‡ºä¸€è‡´**: æ ‡å‡†åŒ–çš„è¿”å›æ ¼å¼

### æ€§èƒ½æå‡
- **æ‰§è¡Œé€Ÿåº¦**: å‡å°‘ä¸å¿…è¦çš„è®¡ç®—
- **å†…å­˜ä½¿ç”¨**: åˆ é™¤å†—ä½™æ•°æ®ç»“æ„
- **æ—¥å¿—ä¼˜åŒ–**: å‡å°‘IOæ“ä½œ

## ğŸ¯ æ ¸å¿ƒä»·å€¼

1. **å¯é æ€§**: ç®€åŒ–é€»è¾‘å‡å°‘bugé£é™©
2. **æ ‡å‡†åŒ–**: ç¬¦åˆé¢„æœŸçš„è¾“å‡ºæ ¼å¼
3. **å¯ç»´æŠ¤**: æ¸…æ™°çš„ä»£ç ç»“æ„
4. **é«˜æ•ˆ**: ä¼˜åŒ–çš„æ€§èƒ½è¡¨ç°
5. **æ˜“ç”¨**: ç®€å•çš„APIæ¥å£

## ğŸ“ åç»­å»ºè®®

1. **å•å…ƒæµ‹è¯•**: ä¸ºå…³é”®è®¡ç®—é€»è¾‘æ·»åŠ æµ‹è¯•
2. **æ€§èƒ½åŸºå‡†**: å»ºç«‹æ€§èƒ½ç›‘æ§æŒ‡æ ‡
3. **é…ç½®ç®¡ç†**: ä¼˜åŒ–é…ç½®æ–‡ä»¶ç»“æ„
4. **æ–‡æ¡£å®Œå–„**: æ·»åŠ APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
5. **é›†æˆæµ‹è¯•**: ä¸å®é™…æ•°æ®çš„ç«¯åˆ°ç«¯æµ‹è¯•

---
*ä¼˜åŒ–å®Œæˆæ—¶é—´: 2024å¹´*
*ä¼˜åŒ–ç›®æ ‡: å¯é ã€ç®€å•ã€é«˜æ•ˆçš„å›æµ‹å¼•æ“*
